<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>BlockBlast WebGL</title>

    <!-- Preload больших файлов -->
    <link rel="preload" href="Build/BlockBlastWeb2.framework.js?v=2" as="script" />
    <link rel="preload" href="Build/BlockBlastWeb2.data?v=2"        as="fetch" crossorigin="anonymous" />
    <link rel="preload" href="Build/BlockBlastWeb2.wasm?v=2"        as="fetch" crossorigin="anonymous" />

    <!-- Мобильная мета -->
    <meta name="viewport"
          content="width=device-width, height=device-height, initial-scale=1.0, user-scalable=no, shrink-to-fit=yes"/>

    <style>
      :root{ --bg:#121212; --bar-bg:rgba(255,255,255,.25); --bar:#fff; }
      html,body{ margin:0; height:100%; background:#000;
        font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
      #stage{ position:relative; height:100%; width:100%; overflow:hidden; display:grid; place-items:center; }

      /* Портрет 600x900 по центру */
      .viewport{ position:relative; width:600px; height:900px; max-width:100vw; max-height:100vh; }
      @media (pointer:coarse){ .viewport{ width:100vw; height:100vh; } }

      /* Canvas виден под лоадером сразу */
      #unity-canvas{
        position:absolute; inset:0; width:100%; height:100%;
        background:#231F20; outline:none;
      }

      /* Лоадер-оверлей с фоном */
      .loader{
        position:absolute; inset:0; z-index:2; display:flex; flex-direction:column;
        justify-content:flex-end; align-items:center;
        background: url("TemplateData/loading-bg.png") center/cover no-repeat, var(--bg);
        transition:opacity .3s ease;
      }
      .loader.hidden{ opacity:0; pointer-events:none; }

      .title{ color:#fff; font-weight:700; font-size:22px; margin-bottom:16px;
        text-shadow:0 2px 6px rgba(0,0,0,.6); }
      .bar{ width:min(300px,80%); height:14px; margin-bottom:14px;
        background:var(--bar-bg); border-radius:999px; overflow:hidden;
        box-shadow:inset 0 0 0 1px rgba(0,0,0,.15); }
      .fill{ width:0%; height:100%; background:var(--bar); transition:width .18s linear; }
      .hint{ color:rgba(255,255,255,.9); font-size:14px; margin-bottom:64px;
        text-shadow:0 1px 4px rgba(0,0,0,.5); }
    </style>
  </head>

  <body>
    <div id="stage">
      <div class="viewport">
        <canvas id="unity-canvas" width="600" height="900" tabindex="-1"></canvas>

        <div class="loader" id="loader">
          <div class="title">Загрузка игры…</div>
          <div class="bar"><div class="fill" id="progress"></div></div>
          <div class="hint" id="hint">Подготавливаем движок…</div>
        </div>
      </div>
    </div>

    <script src="Build/BlockBlastWeb2.loader.js"></script>
    <script>
      // Мобильная растяжка для старых устройств
      if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
        const vp = document.querySelector('.viewport');
        vp.style.width = "100vw";
        vp.style.height = "100vh";
      }

      const canvas   = document.getElementById('unity-canvas');
      const loaderEl = document.getElementById('loader');
      const fillEl   = document.getElementById('progress');
      const hintEl   = document.getElementById('hint');

      const config = {
        arguments: [],
        dataUrl: "Build/BlockBlastWeb2.data?v=2",
        frameworkUrl: "Build/BlockBlastWeb2.framework.js?v=2",
        codeUrl: "Build/BlockBlastWeb2.wasm?v=2",
        streamingAssetsUrl: "StreamingAssets",
        companyName: "DefaultCompany",
        productName: "My project (1)",
        productVersion: "2.1.1",
        showBanner: function(){},
        // devicePixelRatio: 1, // включите для ускорения на ретина-экранах
      };

      let sawProgress = false;
      function onProgress(p){
        const pct = Math.min(1, Math.max(0, p));
        fillEl.style.width = (pct*100).toFixed(1) + "%";
        hintEl.textContent = pct < .1 ? "Подготавливаем движок…" : (pct < .9 ? "Загружаем ресурсы…" : "Инициализация…");
        if (pct >= .9) loaderEl.classList.add('hidden');
        if (pct > 0) sawProgress = true;
      }

      setTimeout(() => {
        if (!sawProgress) {
          hintEl.textContent = "Нет прогресса. Проверьте в Network, что Build/*.data/.wasm/.js грузятся без 404 и с корректными MIME.";
          console.warn("No progress from Unity loader. Check 404/MIME/CORS.");
        }
      }, 20000);

      createUnityInstance(canvas, config, onProgress)
        .then(() => loaderEl.classList.add('hidden'))
        .catch((err) => {
          loaderEl.classList.remove('hidden');
          hintEl.textContent = "Ошибка: " + err;
          console.error(err);
          alert(err);
        });
    </script>
  </body>
</html>
